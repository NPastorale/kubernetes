apiVersion: v1
kind: Namespace
metadata:
  name: bind9

---
apiVersion: v1
kind: Service
metadata:
  name: bind-nahue-udp
  namespace: bind9
  annotations:
    metallb.universe.tf/allow-shared-ip: "dns"
spec:
  type: LoadBalancer
  loadBalancerIP: 192.168.1.151
  selector:
    app: bind-nahue
  ports:
    - protocol: UDP
      port: 53
      targetPort: 53

---
apiVersion: v1
kind: Service
metadata:
  name: bind-nahue-tcp
  namespace: bind9
  annotations:
    metallb.universe.tf/allow-shared-ip: "dns"
spec:
  type: LoadBalancer
  loadBalancerIP: 192.168.1.151
  selector:
    app: bind-nahue
  ports:
    - protocol: TCP
      port: 53
      targetPort: 53

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: bind-nahue
  namespace: bind9
data:
  nahue.com.ar.zone: |
    $TTL 3600
    nahue.com.ar. IN     SOA    ns1.nahue.freeddns.org. admin@nahue.com.ar. (
            2022030109  ; Serial
            1H          ; refresh after 1 hour
            1H          ; retry after 1 hour
            1W          ; expire after 1 week
            1D)         ; minimum TTL of 1 day


                    IN	NS      ns1.nahue.freeddns.org.
                    IN	NS      ns2.nahue.freeddns.org.
                    IN	NS      ns3.nahue.freeddns.org.
                    IN	NS      ns4.nahue.freeddns.org.
    @               IN  A       213.195.117.90
    mirrors         IN  CNAME   nahue.com.ar.
    unifi           IN  CNAME   nahue.com.ar.
    test            IN  CNAME   nahue.com.ar.
    www             IN  CNAME   nahue.com.ar.
    sync            IN  CNAME   nahue.com.ar.
    deluge          IN  CNAME   nahue.com.ar.
    nahue.com.ar.   CAA 1 issue "letsencrypt.org"

  named.conf: |
    options {
            directory "/var/bind";

            listen-on { any; };
            listen-on-v6 { none; };

            allow-transfer {
                    none;
            };

            pid-file "/var/run/named/named.pid";

            allow-recursion { none; };
            recursion no;
    };

    zone "nahue.com.ar" IN {
            type master;
            file "/etc/bind/master/nahue.com.ar.zone";
    };

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: bind-nahue
  namespace: bind9
  labels:
    app: bind-nahue
spec:
  replicas: 1
  selector:
    matchLabels:
      app: bind-nahue
  template:
    metadata:
      labels:
        app: bind-nahue
    spec:
      volumes:
        - name: bind-nahue
          configMap:
            name: bind-nahue
      containers:
        - name: bind-nahue
          image: npastorale/bind9:9.16.25
          imagePullPolicy: IfNotPresent
          env:
            - name: TZ
              value: "Europe/Madrid"
          ports:
            - containerPort: 53
          livenessProbe:
            tcpSocket:
              port: 53
            initialDelaySeconds: 3
            periodSeconds: 3
          readinessProbe:
            tcpSocket:
              port: 53
            initialDelaySeconds: 3
            periodSeconds: 3
          volumeMounts:
            - name: bind-nahue
              mountPath: /etc/bind/named.conf
              subPath: named.conf
            - name: bind-nahue
              mountPath: /etc/bind/master/nahue.com.ar.zone
              subPath: nahue.com.ar.zone
