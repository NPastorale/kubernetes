apiVersion: v1
kind: ConfigMap
metadata:
  name: zone-update
  namespace: bind9
data:
  main.bash: |
    #!/bin/bash


    #######################################################
    #                                                     #
    #  Obtains the current external IP, compares it       #
    #  against the defined IPs in the bind config         #
    #  file and, if they do not match, it modifies them   #
    #                                                     #
    #######################################################


    #############
    # Variables #
    #############

    # Files to be modified
    bindconfig=/etc/bind/master/nahue.ar.zone
    tmpbindconfig=/tmp/zonefile
    cmyaml=/tmp/zonefile.yaml

    # Current external IP
    currextip=$(curl --silent --connect-timeout 5 --max-time 10 --retry 5 --retry-delay 0 --retry-max-time 40 'https://ifconfig.me' | grep -Eo '([0-9]*\.){3}[0-9]*' | grep -v '127.0.0.1')

    # Current bind config file IP
    currbindip=$(grep -Eo '([0-9]*\.){3}[0-9]*' $bindconfig)

    # Current serial number
    currbindser=$(grep Serial $bindconfig | grep -Eo '([0-9]*)')

    # Current serial number substring
    currbindsersub=${currbindser:0:8}

    # Same date serial plus one
    newserial1=$((currbindser + 1))

    # Current date YYYYMMDD
    currdate=$(date +%Y%m%d)

    # Current date serial format YYYYMMDDXX
    newserial=$(date +%Y%m%d)01



    echo "Starting dynbind process"

    if [ -z "$currextip" ]; # Checks if currextip has zero lenght
    then
      echo "Zero length IP"
      echo "Terminated"
      return 1
    fi

    if ping -c 1 -n -q -s 4 -W 5 8.8.8.8 &> /dev/null ;
    then
      if [ "$currextip" != "$currbindip" ] # Compares the current external IP against the one in the zone file
      then
        echo "Internet is reachable"
        echo "External IP and Bind IP are different"
            cp $bindconfig $tmpbindconfig
        sed -i -e "s/$currbindip/$currextip/g" "$tmpbindconfig" # Replaces all the occurrences of current file IP found with the new IP on bindconfig
        echo "Updating IPs..."
        if [ "$currbindsersub" = "$currdate" ] # Compares the date within the current serial number against the current date
        then
          sed -i -e "s/$currbindser/$newserial1/g" "$tmpbindconfig" # Adds one to the current serial on bindconfig
          echo "Serial is from the same date. Adding one..."
        else
          sed -i -e "s/$currbindser/$newserial/g" "$tmpbindconfig" # Replaces the old serial with the new one on bindconfig
          echo "Serial is from different date. Changing serial..."
        fi

            {
                printf 'data:\n'
                printf '  nahue.ar.zone: |\n'

                while IFS="" read -r line; do
                    echo "    $line"
                done
            } < $tmpbindconfig > $cmyaml
            #kubectl magic
            kubectl patch configmap/bind-nahue -n bind9 --type merge --patch-file $cmyaml
            kubectl rollout restart -n bind9 deployment bind-nahue

      else
        echo "External IP and Bind IP match"
        echo "Terminated"
        exit
      fi
    else
      echo "Internet is unreachable"
      echo "Terminated"
      exit
    fi

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: bind-kubectl
  namespace: bind9
spec:
  schedule: "* * * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 4
  jobTemplate:
    spec:
      template:
        spec:
          volumes:
            - name: bind-nahue
              configMap:
                name: bind-nahue
            - name: zone-update
              configMap:
                name: zone-update
                defaultMode: 0755
          serviceAccountName: bind-kubectl
          containers:
            - name: bind-kubectl
              image: npastorale/kubectl
              command: ["/main.bash"]
              volumeMounts:
                - name: bind-nahue
                  mountPath: /etc/bind/named.conf
                  subPath: named.conf
                - name: bind-nahue
                  mountPath: /etc/bind/master/nahue.ar.zone
                  subPath: nahue.ar.zone
                - name: zone-update
                  mountPath: /main.bash
                  subPath: main.bash
          restartPolicy: OnFailure

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: bind-kubectl
  namespace: bind9

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: patch-configmap
  namespace: bind9
rules:
  - apiGroups:
      - ""
    resources:
      - "configmaps"
    verbs:
      - "get"
      - "patch"

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: patch-configmap-to-sa
  namespace: bind9
subjects:
  - kind: ServiceAccount
    name: bind-kubectl
roleRef:
  kind: Role
  name: patch-configmap
  apiGroup: rbac.authorization.k8s.io

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: restart-deployment
  namespace: bind9
rules:
  - apiGroups:
      - "apps"
    resources:
      - "deployments"
    verbs:
      - "get"
      - "patch"

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: restart-deployment-to-sa
  namespace: bind9
subjects:
  - kind: ServiceAccount
    name: bind-kubectl
roleRef:
  kind: Role
  name: restart-deployment
  apiGroup: rbac.authorization.k8s.io
