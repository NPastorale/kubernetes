apiVersion: v1
kind: Namespace
metadata:
  name: syncthing

---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: syncthing-config-pv
  labels:
    type: local
spec:
  storageClassName: manual
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteMany
  nfs:
    server: 192.168.1.2
    path: "/share/k8s-volumes/syncthing/syncthing-config"

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: syncthing-config-pvc
  namespace: syncthing
spec:
  storageClassName: manual
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi

---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: syncthing-data-pv
  labels:
    type: local
spec:
  storageClassName: manual
  capacity:
    storage: 100Gi
  accessModes:
    - ReadWriteMany
  nfs:
    server: 192.168.1.2
    path: "/share/k8s-volumes/syncthing/syncthing-data"

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: syncthing-data-pvc
  namespace: syncthing
spec:
  storageClassName: manual
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 100Gi

---
apiVersion: v1
kind: Service
metadata:
  name: syncthing-tcp
  namespace: syncthing
  annotations:
    metallb.universe.tf/allow-shared-ip: "syncthing"
spec:
  type: LoadBalancer
  loadBalancerIP: 192.168.1.154
  selector:
    app: syncthing
  ports:
    - name: web
      protocol: TCP
      port: 8384
      targetPort: 8384
    - name: sync
      protocol: TCP
      port: 22000
      targetPort: 22000

---
apiVersion: v1
kind: Service
metadata:
  name: syncthing-udp
  namespace: syncthing
  annotations:
    metallb.universe.tf/allow-shared-ip: "syncthing"
spec:
  type: LoadBalancer
  loadBalancerIP: 192.168.1.154
  selector:
    app: syncthing
  ports:
    - name: sync
      protocol: UDP
      port: 22000
      targetPort: 22000
    - name: discovery
      protocol: UDP
      port: 21027
      targetPort: 21027

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: syncthing
  namespace: syncthing
  labels:
    app: syncthing
spec:
  replicas: 1
  selector:
    matchLabels:
      app: syncthing
  template:
    metadata:
      labels:
        app: syncthing
    spec:
      volumes:
        - name: config
          persistentVolumeClaim:
            claimName: syncthing-config-pvc
        - name: data
          persistentVolumeClaim:
            claimName: syncthing-data-pvc
      containers:
        - name: syncthing
          image: lscr.io/linuxserver/syncthing:1.19.0
          imagePullPolicy: IfNotPresent
          env:
            - name: hostname
              value: syncthing-server
            - name: TZ
              value: "Europe/Madrid"
            - name: PUID
              value: "65534"
            - name: GUID
              value: "65534"
          ports:
            - containerPort: 8384
            - containerPort: 22000
            - containerPort: 21027
          volumeMounts:
            - name: config
              mountPath: /config
              readOnly: false
            - name: data
              mountPath: /data
              readOnly: false

---
# apiVersion: networking.k8s.io/v1
# kind: Ingress
# metadata:
#   name: unifi-ingress
#   namespace: unifi
#   annotations:
#     cert-manager.io/cluster-issuer: "letsencrypt-prod"
#     nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
# spec:
#   ingressClassName: nginx
#   tls:
#     - hosts:
#         - unifi.nahue.com.ar
#       secretName: unifi
#   rules:
#     - host: unifi.nahue.com.ar
#       http:
#         paths:
#           - path: /
#             pathType: Prefix
#             backend:
#               service:
#                 name: unifi-tcp
#                 port:
#                   number: 443
