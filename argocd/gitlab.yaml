apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: gitlab
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  destination:
    namespace: gitlab
    server: https://kubernetes.default.svc
  project: default
  source:
    chart: gitlab
    repoURL: https://charts.gitlab.io/
    targetRevision: v8.3.1
    helm:
      values: |
        global:
          minio:
            enabled: true
            storageClass: nfs-csi-ephemeral
          edition: ce
          hosts:
            domain: nahue.ar
            https: true
            ssh: gitlab.nahue.ar
            gitlab: {}
            registry:
              name: registry.nahue.ar
              https: false
            tls: {}
            smartcard: {}
            kas:
              name: kas.gitlab.nahue.ar
              https: false
            pages:
              name: pages.gitlab.nahue.ar
              https: true
          ingress:
            apiVersion: ""
            configureCertmanager: false
            provider: nginx
            class: external-nginx
            annotations:
              cert-manager.io/cluster-issuer: "letsencrypt-prod"
            enabled: true
            tls:
              enabled: true
            path: /
            pathType: Prefix
          psql:
            database: app
            username: app
            password:
              useSecret: true
              secret: postgres-gitlab-app
              key: password
            host: postgres-gitlab-rw
          appConfig:
            terraformState:
              enabled: false
            lfs:
              enabled: false
            artifacts:
              enabled: false
            uploads:
              enabled: false
            packages:
              enabled: false
            externalDiffs:
              enabled: false
            dependencyProxy:
              enabled: false
            ciSecureFiles:
              enabled: false
            omniauth:
              enabled: false
          smtp:
            enabled: false
        upgradeCheck:
          enabled: false
        certmanager:
          install: false
        nginx-ingress:
          enabled: false
        postgresql:
          install: false
        gitlab-runner:
          install: true
          gitlabUrl: "https://gitlab.nahue.ar"
          rbac:
            create: true
          checkInterval: 3
          runners:
            locked: false
            config: |
              [[runners]]
                url = "https://gitlab.nahue.ar"
                clone_url = "https://gitlab.nahue.ar"
                [runners.kubernetes]
                privileged = true
                image = "alpine:latest"
          podAnnotations:
            gitlab.com/prometheus_scrape: "true"
            gitlab.com/prometheus_port: 9252
        gitlab:
          sidekiq:
            resources:
              requests:
                cpu: 450m
          webservice:
            resources:
              requests:
                cpu: 150m
            ingress:
              tls:
                secretName: gitlab-tls
          kas:
            ingress:
              tls:
                secretName: kas-tls
          toolbox:
        registry:
          ingress:
            tls:
              secretName: registry-tls
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
